<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dev Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* CSS SAME AS web_interface.h */
    :root { --bg: #101014; --card: #1b1b26; --accent: #00e5ff; --text: #eee; }
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; text-align: center; }
    
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }
    .card { background: var(--card); border-radius: 12px; padding: 15px; border: 1px solid #333; }
    h3 { margin-top: 0; color: var(--accent); font-size: 0.9em; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 8px;}

    .chart-box { height: 250px; width: 100%; }
    #matrixCanvas { background: #000; border-radius: 4px; box-shadow: 0 0 10px rgba(0,0,0,0.5); margin-top: 10px; }
    
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
    button { background: #333; color: var(--accent); border: 1px solid var(--accent); padding: 8px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
    button:hover { background: var(--accent); color: #000; }
    
    input[type=range] { width: 100%; accent-color: var(--accent); margin: 10px 0; }
    label { font-size: 0.8em; color: #888; display: flex; justify-content: space-between; }

    .status-bar { grid-column: 1 / -1; display: flex; justify-content: space-between; font-size: 0.8em; color: #666; background: #000; padding: 5px 15px; border-radius: 20px; margin-bottom: 20px; }
    .status-indicator { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; background-color: #555; }
  </style>
</head>
<body>

  <div class="status-bar">
    <span>DEVICE: <b>ESP32-S3 (DEV)</b></span>
    <span><span id="connDot" class="status-indicator"></span><span id="connStatus">Disconnected</span></span>
    <span>FPS: <b id="fps">0</b></span>
    <span>LATENCY: <b id="latency">0 ms</b></span>
  </div>

  <div class="dashboard">
    <div class="card" style="grid-column: span 2;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>Signal Analysis</h3>
        <div>
           <label style="display:inline; margin-right:10px;"><input type="radio" name="view" onclick="toggleView(0)" checked> FFT Spectrum</label>
           <label style="display:inline;"><input type="radio" name="view" onclick="toggleView(1)"> Waveform</label>
        </div>
      </div>
      <div class="chart-box"><canvas id="mainChart"></canvas></div>
    </div>

    <div class="card">
      <h3>Hardware Preview</h3>
      <div style="display:flex; justify-content:center;">
        <canvas id="matrixCanvas" width="160" height="160"></canvas>
      </div>
    </div>

    <div class="card">
      <h3>System Controls</h3>
      <label>Preset Profiles</label>
      <div class="btn-grid">
        <button onclick="send('P',0)">Music</button>
        <button onclick="send('P',1)">Speech</button>
        <button onclick="send('P',2)">Gaming</button>
        <button onclick="send('P',3)">Quiet</button>
      </div>
      <label>Sensitivity <span id="valS">50%</span></label>
      <input type="range" min="1" max="100" value="50" oninput="send('S',this.value)">
      <label>Brightness <span id="valB">40%</span></label>
      <input type="range" min="0" max="255" value="40" oninput="send('B',this.value)">
    </div>
  </div>

<script>
  // --- DEV CONFIG ---
  // ESP32 IP
  const espIP = "172.20.10.2"; 
  
  var gateway = `ws://${espIP}:81/`;
  var websocket;
  var lastPacketTime = 0;
  var isWaveform = false;

  var ctx = document.getElementById('mainChart').getContext('2d');
  var gradient = ctx.createLinearGradient(0, 0, 0, 300);
  gradient.addColorStop(0, 'rgba(0, 229, 255, 1)'); 
  gradient.addColorStop(1, 'rgba(0, 229, 255, 0.05)');

  var chart = new Chart(ctx, {
      type: 'bar',
      data: {
          labels: ['60Hz','150Hz','300Hz','600Hz','1.2k','2.5k','5k','10k'],
          datasets: [{ data: [], backgroundColor: gradient, borderColor: '#00e5ff', borderWidth: 1, borderRadius: 4, tension: 0.4 }]
      },
      options: {
          responsive: true, maintainAspectRatio: false, animation: false,
          scales: { y: { display: false, min: -1500, max: 1500 }, x: { grid: { display:false }, ticks: { color:'#555'} } },
          plugins: { legend: { display: false } }
      }
  });

  var mCtx = document.getElementById('matrixCanvas').getContext('2d');
  function drawMatrix(bands) {
    mCtx.clearRect(0, 0, 160, 160);
    for(let x=0; x<8; x++) {
      let height = bands[x];
      for(let y=0; y<8; y++) {
        if ((7-y) < height) {
           mCtx.fillStyle = `hsl(${x*30}, 100%, 50%)`; 
           mCtx.shadowBlur = 10; mCtx.shadowColor = mCtx.fillStyle;
        } else {
           mCtx.fillStyle = '#222'; mCtx.shadowBlur = 0;
        }
        mCtx.beginPath(); mCtx.arc(x*20 + 10, y*20 + 10, 8, 0, Math.PI*2); mCtx.fill();
      }
    }
  }

  function initWebSocket() {
    websocket = new WebSocket(gateway);
    websocket.onopen = () => { 
       document.getElementById('connStatus').innerHTML = "Connected"; 
       document.getElementById('connDot').style.backgroundColor = "#0f0";
    };
    websocket.onmessage = (e) => {
       var now = Date.now();
       if(lastPacketTime > 0) document.getElementById('latency').innerText = (now - lastPacketTime) + " ms";
       lastPacketTime = now;

       var d = JSON.parse(e.data);
       if (d.fps) document.getElementById('fps').innerText = d.fps;

       if (isWaveform && d.wave) {
          chart.data.datasets[0].data = d.wave;
          chart.options.scales.y.min = -2000; chart.options.scales.y.max = 2000;
          chart.update();
       } 
       else if (!isWaveform && d.fft) {
          chart.data.datasets[0].data = d.fft.map(v => v * 150);
          chart.options.scales.y.min = 0; chart.options.scales.y.max = 1200;
          drawMatrix(d.fft);
       }
       chart.update();
    };
  }

  function toggleView(mode) {
     isWaveform = (mode === 1);
     send('W', mode);
     chart.config.type = isWaveform ? 'line' : 'bar';
     chart.data.labels = isWaveform ? Array(32).fill('') : ['60Hz','150Hz','300Hz','600Hz','1.2k','2.5k','5k','10k'];
     chart.update();
  }

  function send(k, v) {
     websocket.send(k + ":" + v);
     if(k=='S') document.getElementById('valS').innerText = v + "%";
     if(k=='B') document.getElementById('valB').innerText = v + "%";
  }

  window.onload = initWebSocket;
</script>
</body>
</html>